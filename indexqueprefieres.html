<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¿Qué prefieres?</title>
  <style>
    :root {
      --bg: #0f1220;
      --card: #171a2b;
      --text: #e9ecff;
      --muted: #96a0c8;
      --a: #3fa7ff;
      --b: #ff5a76;
      --ok: #35d399;
      --warn: #ffd166;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, #1d2140 0%, var(--bg) 60%);
      color: var(--text);
      display: grid; place-items: center;
    }
    .app { width: min(980px, 96vw); padding: 24px; }

    header { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 18px; }
    .brand { display: flex; gap: 10px; align-items: center; }
    .logo { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, var(--a), var(--b)); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .brand h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }

    nav { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .btn { cursor: pointer; border: 0; padding: 10px 14px; border-radius: 12px; background: #232845; color: var(--text); font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.15); }
    button:hover, .btn:hover { filter: brightness(1.05); }
    .primary { background: linear-gradient(135deg, var(--a), #6ad1ff); color: #07111f; }
    .danger { background: linear-gradient(135deg, #ff6b6b, #ff8fa3); color: #230b0b; }

    .card { background: var(--card); border: 1px solid #23284a; border-radius: 18px; padding: 18px; box-shadow: 0 12px 40px rgba(0,0,0,.25); }

    .center { text-align: center; }
    .muted { color: var(--muted); font-size: 14px; }

    .question-text { font-size: clamp(22px, 4vw, 36px); font-weight: 800; line-height: 1.15; margin: 4px 0 18px; text-wrap: balance; }

    .options { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 700px) { .options { grid-template-columns: 1fr 1fr; } }

    .option {
      border-radius: 16px; padding: 0; min-height: 110px; display: grid; grid-template-rows: auto auto; align-items: stretch; text-align: center; font-size: 18px; font-weight: 700;
      border: 1px solid rgba(255,255,255,.06);
      transition: transform .08s ease, box-shadow .15s ease;
      user-select: none; overflow: hidden;
    }
    .option:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .option.a { background: linear-gradient(135deg, rgba(63,167,255,.15), rgba(63,167,255,.07)); }
    .option.b { background: linear-gradient(135deg, rgba(255,90,118,.15), rgba(255,90,118,.07)); }

    .opt-media { aspect-ratio: 16/9; width: 100%; background: #0d1022; display: grid; place-items: center; overflow: hidden; }
    .opt-media img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .opt-caption { padding: 14px; }

    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 680px) { .row.two { grid-template-columns: 1fr 1fr; } }

    input[type="text"], textarea, input[type="url"] {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #2b315c; background: #11152b; color: var(--text); font-size: 16px;
    }
    label { font-size: 14px; color: var(--muted); margin-bottom: 6px; display: inline-block; }

    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .bar { height: 14px; background: #0d1022; border-radius: 10px; overflow: hidden; border: 1px solid #242a52; }
    .fill { height: 100%; }
    .fill.a { background: var(--a); }
    .fill.b { background: var(--b); }

    .stack { display: grid; gap: 14px; }
    .hidden { display: none !important; }
    .right { text-align: right; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #232845; color: var(--muted); font-size: 12px; display: inline-flex; gap: 6px; align-items: center; }

    .thumbs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .thumbs .thumb { aspect-ratio: 16/9; background:#0d1022; border:1px solid #242a52; border-radius: 10px; overflow:hidden; display:grid; place-items:center; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    footer { margin-top: 16px; text-align: center; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";


// Verificar si hay usuario logueado
const { data, error } = await sb.auth.getUser();

if (error || !data.user) {
  window.location.href = "index.html"; // Redirige si no hay sesión
}
</script>

  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>¿Qué prefieres?</h1>
      </div>
    <nav>
      <button id="navPlay">Jugar</button>
      <button id="navCreate">Crear</button>
      <button id="navFeed">Explorar</button>

      <div class="auth">
        <span id="authUser" class="meta">Invitado</span>
        <button id="btnSignIn" class="primary">Iniciar sesión</button>
        <button id="btnSignOut" class="hidden">Salir</button>
      </div>
    </nav>

    </header>

    <!-- HOME / PLAY -->
    <section id="viewPlay" class="card center">
      <p class="muted">Pregunta creada por <span id="qAuthor">—</span></p>
      <h2 id="qText" class="question-text">Cargando…</h2>
      <div class="options">
        <div id="optA" role="button" tabindex="0" class="option a">
          <div class="opt-media" id="mediaA"></div>
          <div class="opt-caption" id="captionA">Opción A</div>
        </div>
        <div id="optB" role="button" tabindex="0" class="option b">
          <div class="opt-media" id="mediaB"></div>
          <div class="opt-caption" id="captionB">Opción B</div>
        </div>
      </div>
      <div id="result" class="stack hidden">
        <div class="row two">
          <div class="pill">A: <strong id="pctA">0%</strong></div>
          <div class="pill right">B: <strong id="pctB">0%</strong></div>
        </div>
        <div class="stats">
          <div class="bar"><div id="fillA" class="fill a" style="width:0%"></div></div>
          <div class="bar"><div id="fillB" class="fill b" style="width:0%"></div></div>
        </div>
        <div class="row two">
          <button id="next" class="btn">Siguiente pregunta ▶</button>
          <button id="share" class="btn">Compartir</button>
        </div>
      </div>
    </section>

    <!-- CREATE -->
    <section id="viewCreate" class="card stack hidden">
      <h3 class="center" style="margin:0">Crear un “¿Qué prefieres?”</h3>
      <p class="muted center">El texto queda centrado; puedes añadir imágenes a cada opción (URL o archivo).</p>
      <div class="stack">
        <div>
          <label for="inpQ">Pregunta</label>
          <textarea id="inpQ" rows="3" placeholder="¿Qué prefieres…?"></textarea>
        </div>
        <div class="row two">
          <div class="stack">
            <label>Opción A</label>
            <input id="inpA" type="text" placeholder="Texto de la opción A" />
            <input id="urlA" type="url" placeholder="URL de imagen (opcional)" />
            <input id="fileA" type="file" accept="image/*" />
            <div class="thumbs"><div class="thumb"><img id="prevA" alt=""/></div></div>
          </div>
          <div class="stack">
            <label>Opción B</label>
            <input id="inpB" type="text" placeholder="Texto de la opción B" />
            <input id="urlB" type="url" placeholder="URL de imagen (opcional)" />
            <input id="fileB" type="file" accept="image/*" />
            <div class="thumbs"><div class="thumb"><img id="prevB" alt=""/></div></div>
          </div>
        </div>
        <div class="row two">
          <button id="saveQ" class="primary">Publicar</button>
          <button id="clearForm">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- FEED -->
    <section id="viewFeed" class="card stack hidden">
      <h3 style="margin:0">Explorar preguntas</h3>
      <div id="feedList" class="stack"></div>
    </section>

    <!-- LOGIN -->
    <section id="viewLogin" class="card stack hidden">
      <h3 style="margin:0" class="center">Tu usuario</h3>
      <p class="muted center">Por ahora es local (nickname). En la versión online será con email/Google.</p>
      <div class="row two">
        <div>
          <label for="nick">Nickname</label>
          <input id="nick" type="text" placeholder="Ej: PanitaXD" />
        </div>
        <div class="stack">
          <label>&nbsp;</label>
          <button id="setNick" class="primary">Guardar</button>
          <button id="logout" class="danger">Borrar usuario local</button>
        </div>
      </div>
      <p class="muted">Estado: <span id="authState">—</span></p>
    </section>

    <footer>
      Hecho con ❤️ para prototipo. Votos, usuario e imágenes (base64/URL) guardados en <strong>localStorage</strong>.
    </footer>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/*********************************
 * PEQUEÑA "BASE DE DATOS" LOCAL *
 *********************************/
const DB_KEY = 'qp_db_v2_images';
const USER_KEY = 'qp_user_v1';

// ====== CONFIGURACIÓN SUPABASE ======
const SUPABASE_URL = "https://jrzpqsgjghopnnntxypp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyenBxc2dqZ2hvcG5ubnR4eXBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5ODcsImV4cCI6MjA3NDgyMzk4N30.Wv-4VQOYtgH5q_X8AsnwJSXqvgWfiGul7hki08KoemU";

// ✅ Cliente único de Supabase
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Referencias UI
const authUser = document.getElementById('authUser');
const btnSignIn = document.getElementById('btnSignIn');
const btnSignOut = document.getElementById('btnSignOut');

/********************
 * FUNCIONES USUARIO
 ********************/
function setUser(nick) {
  const nickTrim = nick.trim();
  localStorage.setItem(USER_KEY, JSON.stringify({ id: 'local:' + nickTrim.toLowerCase(), nick: nickTrim }));
  localStorage.setItem("nickname", nickTrim);
}

function getUser() {
  const raw = localStorage.getItem(USER_KEY);
  if (raw) {
    try { return JSON.parse(raw); } catch {}
  }
  const nick = localStorage.getItem("nickname");
  if (nick) return { id: 'local:' + nick.toLowerCase(), nick };
  const session = window._lastSupabaseSession;
  const email = session?.user?.email;
  if (email) return { id: 'supabase:' + email.toLowerCase(), nick: email };
  return null;
}

function delUser() {
  localStorage.removeItem(USER_KEY);
  localStorage.removeItem("nickname");
}

// ✅ Sincronizar nickname local al iniciar sesión
async function syncUserNickname() {
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;
  window._lastSupabaseSession = data?.session || null;

  if (!user) return;

  let localUser = getUser();
  if (!localUser) {
    let nickname = localStorage.getItem("nickname");
    if (!nickname) {
      nickname = prompt("Ingresa tu nickname (solo la primera vez):");
    }
    if (nickname) setUser(nickname);
  }
}

/********************
 * LOGIN / LOGOUT
 ********************/
btnSignIn.addEventListener('click', async () => {
  const email = prompt("📧 Ingresa tu correo para iniciar sesión:");
  if (!email) return alert("Debes ingresar un correo.");
  const nickname = prompt("🧠 Ingresa tu nickname (solo la primera vez):");
  if (!nickname) return alert("Debes ingresar un nickname.");
  setUser(nickname);
  const { error } = await sb.auth.signInWithOtp({
    email: email,
    options: {
      emailRedirectTo: "https://luiskq1225-dotcom.github.io/survigames/"
    }
  });
  if (error) alert("Error al enviar el enlace: " + error.message);
  else alert("📩 Te enviamos un enlace mágico a tu correo. Revisa tu bandeja!");
});

btnSignOut.addEventListener('click', async () => {
  await sb.auth.signOut();
  delUser();
  authUser.textContent = "Invitado";
  btnSignIn.classList.remove('hidden');
  btnSignOut.classList.add('hidden');
  alert("Sesión cerrada correctamente.");
});

// ✅ Detectar cambios de sesión
sb.auth.onAuthStateChange(async (_event, session) => {
  window._lastSupabaseSession = session;
  const user = session?.user;
  if (user) {
    authUser.textContent = user.email;
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');
    await syncUserNickname();
  } else {
    authUser.textContent = 'Invitado';
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
  }
});

// ✅ Revisar si ya estaba logueado al abrir la página
(async () => {
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;
  window._lastSupabaseSession = data?.session || null;

  if (user) {
    authUser.textContent = user.email;
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');
    await syncUserNickname();
  } else {
    authUser.textContent = 'Invitado';
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
  }
})();
</script>

</body>
</html>


