<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¬øQu√© prefieres?</title>
  <style>
    :root {
      --bg: #0f1220;
      --card: #171a2b;
      --text: #e9ecff;
      --muted: #96a0c8;
      --a: #3fa7ff;
      --b: #ff5a76;
      --ok: #35d399;
      --warn: #ffd166;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 80% -10%, #1d2140 0%, var(--bg) 60%);
      color: var(--text);
      display: grid; place-items: center;
    }
    .app { width: min(980px, 96vw); padding: 24px; }

    header { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 18px; }
    .brand { display: flex; gap: 10px; align-items: center; }
    .logo { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, var(--a), var(--b)); box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .brand h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }

    nav { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .btn { cursor: pointer; border: 0; padding: 10px 14px; border-radius: 12px; background: #232845; color: var(--text); font-weight: 600; box-shadow: 0 6px 18px rgba(0,0,0,.15); }
    button:hover, .btn:hover { filter: brightness(1.05); }
    .primary { background: linear-gradient(135deg, var(--a), #6ad1ff); color: #07111f; }
    .danger { background: linear-gradient(135deg, #ff6b6b, #ff8fa3); color: #230b0b; }

    .card { background: var(--card); border: 1px solid #23284a; border-radius: 18px; padding: 18px; box-shadow: 0 12px 40px rgba(0,0,0,.25); }

    .center { text-align: center; }
    .muted { color: var(--muted); font-size: 14px; }

    .question-text { font-size: clamp(22px, 4vw, 36px); font-weight: 800; line-height: 1.15; margin: 4px 0 18px; text-wrap: balance; }

    .options { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 700px) { .options { grid-template-columns: 1fr 1fr; } }

    .option {
      border-radius: 16px; padding: 0; min-height: 110px; display: grid; grid-template-rows: auto auto; align-items: stretch; text-align: center; font-size: 18px; font-weight: 700;
      border: 1px solid rgba(255,255,255,.06);
      transition: transform .08s ease, box-shadow .15s ease;
      user-select: none; overflow: hidden;
    }
    .option:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.25); }
    .option.a { background: linear-gradient(135deg, rgba(63,167,255,.15), rgba(63,167,255,.07)); }
    .option.b { background: linear-gradient(135deg, rgba(255,90,118,.15), rgba(255,90,118,.07)); }

    .opt-media { aspect-ratio: 16/9; width: 100%; background: #0d1022; display: grid; place-items: center; overflow: hidden; }
    .opt-media img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .opt-caption { padding: 14px; }

    .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 680px) { .row.two { grid-template-columns: 1fr 1fr; } }

    input[type="text"], textarea, input[type="url"] {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid #2b315c; background: #11152b; color: var(--text); font-size: 16px;
    }
    label { font-size: 14px; color: var(--muted); margin-bottom: 6px; display: inline-block; }

    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .bar { height: 14px; background: #0d1022; border-radius: 10px; overflow: hidden; border: 1px solid #242a52; }
    .fill { height: 100%; }
    .fill.a { background: var(--a); }
    .fill.b { background: var(--b); }

    .stack { display: grid; gap: 14px; }
    .hidden { display: none !important; }
    .right { text-align: right; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #232845; color: var(--muted); font-size: 12px; display: inline-flex; gap: 6px; align-items: center; }

    .thumbs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .thumbs .thumb { aspect-ratio: 16/9; background:#0d1022; border:1px solid #242a52; border-radius: 10px; overflow:hidden; display:grid; place-items:center; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    footer { margin-top: 16px; text-align: center; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";


// Verificar si hay usuario logueado
const { data, error } = await sb.auth.getUser();

if (error || !data.user) {
  window.location.href = "index.html"; // Redirige si no hay sesi√≥n
}
</script>

  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>¬øQu√© prefieres?</h1>
      </div>
    <nav>
      <button id="navPlay">Jugar</button>
      <button id="navCreate">Crear</button>
      <button id="navFeed">Explorar</button>

      <div class="auth">
        <span id="authUser" class="meta">Invitado</span>
        <button id="btnSignIn" class="primary">Iniciar sesi√≥n</button>
        <button id="btnSignOut" class="hidden">Salir</button>
      </div>
    </nav>

    </header>

    <!-- HOME / PLAY -->
    <section id="viewPlay" class="card center">
      <p class="muted">Pregunta creada por <span id="qAuthor">‚Äî</span></p>
      <h2 id="qText" class="question-text">Cargando‚Ä¶</h2>
      <div class="options">
        <div id="optA" role="button" tabindex="0" class="option a">
          <div class="opt-media" id="mediaA"></div>
          <div class="opt-caption" id="captionA">Opci√≥n A</div>
        </div>
        <div id="optB" role="button" tabindex="0" class="option b">
          <div class="opt-media" id="mediaB"></div>
          <div class="opt-caption" id="captionB">Opci√≥n B</div>
        </div>
      </div>
      <div id="result" class="stack hidden">
        <div class="row two">
          <div class="pill">A: <strong id="pctA">0%</strong></div>
          <div class="pill right">B: <strong id="pctB">0%</strong></div>
        </div>
        <div class="stats">
          <div class="bar"><div id="fillA" class="fill a" style="width:0%"></div></div>
          <div class="bar"><div id="fillB" class="fill b" style="width:0%"></div></div>
        </div>
        <div class="row two">
          <button id="next" class="btn">Siguiente pregunta ‚ñ∂</button>
          <button id="share" class="btn">Compartir</button>
        </div>
      </div>
    </section>

    <!-- CREATE -->
    <section id="viewCreate" class="card stack hidden">
<h3 class="center" style="margin:0">Crear un ‚Äú¬øQu√© prefieres?‚Äù</h3>
<div class="card" style="background:#0e1428; border:1px solid #23284a; margin-top:8px; margin-bottom:12px; padding:12px;">
  <h4 style="margin:0; color:#7c5cff;">üß† Consejos para subir im√°genes</h4>
  <ul style="margin:8px 0 0 18px; color:#9aa4b2; font-size:14px; line-height:1.5;">
    <li>Puedes <b>pegar un enlace directo</b> de imagen (ej: <i>https://i.pinimg.com/....jpg</i>).</li>
    <li>O si prefer√≠s, <b>sub√≠ una imagen desde tu dispositivo</b> (bot√≥n ‚ÄúChoose File‚Äù).</li>
    <li>Si pon√©s ambos, se usar√° <b>la URL primero</b> (el archivo queda de respaldo).</li>
    <li>Us√° im√°genes <b>horizontales (16:9)</b> para que se vean bien en la vista de juego.</li>
    <li>Los formatos recomendados son <b>JPG</b> o <b>PNG</b>, tama√±o menor a <b>1 MB</b>.</li>
  </ul>
</div>

<div>
  <label for="inpTags">Etiquetas / Tags</label>
  <input id="inpTags" type="text" list="tagsSugeridos" placeholder="Ej: anime, snk, pareja, acci√≥n" />
  <datalist id="tagsSugeridos"></datalist>

  <p class="muted" style="font-size:13px;margin-top:4px;">
    Separa las etiquetas con comas (,). Ejemplo: <b>anime, snk, acci√≥n</b>
  </p>
</div>

  
<p class="muted center">El texto queda centrado; puedes a√±adir im√°genes a cada opci√≥n (URL o archivo).</p>


          <!-- üí• Imagen principal (banner opcional) -->
      <div class="stack">
        <label for="urlQ">Imagen principal (opcional)</label>
        <input id="urlQ" type="url" placeholder="URL de imagen principal (opcional)" />
        <input id="fileQ" type="file" accept="image/*" />
        <div class="thumbs"><div class="thumb"><img id="prevQ" alt=""/></div></div>
      </div>
      <div class="stack">
        <div>
          <label for="inpQ">Pregunta</label>
          <textarea id="inpQ" rows="3" placeholder="¬øQu√© prefieres‚Ä¶?"></textarea>
        </div>
        <div class="row two">
          <div class="stack">
            <label>Opci√≥n A</label>
            <input id="inpA" type="text" placeholder="Texto de la opci√≥n A" />
            <input id="urlA" type="url" placeholder="URL de imagen (opcional)" />
            <input id="fileA" type="file" accept="image/*" />
            <div class="thumbs"><div class="thumb"><img id="prevA" alt=""/></div></div>
          </div>
          <div class="stack">
            <label>Opci√≥n B</label>
            <input id="inpB" type="text" placeholder="Texto de la opci√≥n B" />
            <input id="urlB" type="url" placeholder="URL de imagen (opcional)" />
            <input id="fileB" type="file" accept="image/*" />
            <div class="thumbs"><div class="thumb"><img id="prevB" alt=""/></div></div>
          </div>
        </div>
        <div class="row two">
          <button id="saveQ" class="primary">Publicar</button>
          <button id="clearForm">Limpiar</button>
        </div>
      </div>
    </section>
    <div>

  <label for="inpTags">Etiquetas (separadas por comas)</label>
  <input id="inpTags" type="text" placeholder="Ej: anime, snk, romance" />
  <p class="muted">Usa comas para separar las categor√≠as o temas.</p>
</div>

    <div id="explorarContainer" class="explorar-lista">
      <!-- Aqu√≠ se insertar√°n autom√°ticamente las preguntas nuevas -->
    </div>

    <!-- FEED -->
    <section id="viewFeed" class="card stack hidden">
      <h3 style="margin:0">Explorar preguntas</h3>

      <!-- üîç Buscador de tags -->
      <div class="row two" style="align-items:center;">
        <input id="searchTag" type="text" placeholder="Buscar por tag (Ej: anime, snk...)" />
        <button id="btnSearchTag" class="primary">Buscar</button>
      </div>

      <!-- üî• Tags populares -->
      <div id="popularTags" class="stack muted" style="margin-top:8px;">
        <p><strong>Tags populares:</strong> <span id="tagsList">Cargando...</span></p>
      </div>

      <div id="feedList" class="stack"></div>
    </section>

    <!-- üîπ Contenedor de tags populares -->
    <div id="popularTags" class="row" style="flex-wrap:wrap; gap:8px; margin-bottom:8px;">
      <p class="muted" id="tagsLoading">Cargando etiquetas populares...</p>
    </div>

    <div id="feedList" class="stack"></div>
  </section>

    <!-- LOGIN -->
    <section id="viewLogin" class="card stack hidden">
      <h3 style="margin:0" class="center">Tu usuario</h3>
      <p class="muted center">Por ahora es local (nickname). En la versi√≥n online ser√° con email/Google.</p>
      <div class="row two">
        <div>
          <label for="nick">Nickname</label>
          <input id="nick" type="text" placeholder="Ej: PanitaXD" />
        </div>

        <label for="profilePic">Foto de perfil</label>
          <input type="file" id="profilePic" accept="image/*" />
          <img id="profilePreview" width="64" height="64" style="border-radius:50%;margin-top:8px;">

        <div class="stack">
          <label>&nbsp;</label>
          <button id="setNick" class="primary">Guardar</button>
          <button id="logout" class="danger">Borrar usuario local</button>
        </div>
      </div>
      <p class="muted">Estado: <span id="authState">‚Äî</span></p>
    </section>

    <footer>
      Hecho con ‚ù§Ô∏è para prototipo. Votos, usuario e im√°genes (base64/URL) guardados en <strong>localStorage</strong>.
    </footer>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /*********************************
     * PEQUE√ëA "BASE DE DATOS" LOCAL *
     *********************************/
    const DB_KEY = 'qp_db_v2_images';
    const USER_KEY = 'qp_user_v1';

    // ====== CONFIGURACI√ìN SUPABASE ======
    const SUPABASE_URL = "https://jrzpqsgjghopnnntxypp.supabase.co"; // tu URL real
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyenBxc2dqZ2hvcG5ubnR4eXBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDc5ODcsImV4cCI6MjA3NDgyMzk4N30.Wv-4VQOYtgH5q_X8AsnwJSXqvgWfiGul7hki08KoemU";

    // Crear el cliente global de Supabase
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // ====== AUTENTICACI√ìN (SUPABASE) ======
    const AUTH_REDIRECT = window.location.origin;
    let CURRENT_USER = null;

    function setAuthUI(user) {
      const elUser = document.getElementById("authUser");
      const btnIn = document.getElementById("btnSignIn");
      const btnOut = document.getElementById("btnSignOut");

      if (user) {
        elUser.textContent = user.email || "Usuario";
        btnIn.classList.add("hidden");
        btnOut.classList.remove("hidden");
      } else {
        elUser.textContent = "Invitado";
        btnIn.classList.remove("hidden");
        btnOut.classList.add("hidden");
      }
    }

    // ‚úÖ Sincronizar nickname local con Supabase
async function syncUserNickname() {
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;

  if (!user) return;

  let localUser = getUser();

  if (!localUser) {
    // Buscar si ya hay nickname
    let nickname = localStorage.getItem("nickname");

    // Si no hay nickname guardado, pedimos uno
    if (!nickname) {
      nickname = prompt("Ingresa tu nickname (solo la primera vez):");
      if (nickname) {
        localStorage.setItem("nickname", nickname.trim());
      } else {
        alert("Debes tener un nickname para continuar.");
        return;
      }
    }

    // Guardar tambi√©n en tu sistema local
    setUser(nickname.trim());
  }
}

  sb.auth.getSession().then(({ data }) => {
    CURRENT_USER = data?.session?.user || null;
    setAuthUI(CURRENT_USER);
  });

  sb.auth.onAuthStateChange((_event, session) => {
    CURRENT_USER = session?.user || null;
    setAuthUI(CURRENT_USER);
  });



    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if (raw) try { return JSON.parse(raw); } catch {}
      // semilla inicial
      const seed = [
        mkQ('¬øQu√© prefieres?', 'Dormir 5 min m√°s', 'Despertar sin sue√±o', 'sistema', null, null),
        mkQ('¬øQu√© prefieres?', 'Comer pizza por un a√±o', 'Comer sushi por un a√±o', 'sistema', null, null),
        mkQ('¬øQu√© prefieres?', 'Tu novio salga con su ex a caf√©', 'Que pierda una pierna üò¨', 'anon', null, null),
        mkQ('¬øQu√© prefieres?', 'Tal chica de anime', 'Tal otra chica de anime', 'anon', null, null)
      ];
      saveDB(seed);
      return seed;
    }
    function saveDB(arr){ localStorage.setItem(DB_KEY, JSON.stringify(arr)); }

    function mkQ(q, a, b, author, aImg, bImg) {
      return { id: crypto.randomUUID(), q, a, b, aImg: aImg||null, bImg: bImg||null, author, votesA: 0, votesB: 0, voters: {} };
    }

 function setUser(nick) {
  const nickTrim = nick.trim();
  localStorage.setItem(USER_KEY, JSON.stringify({ id: 'local:' + nickTrim.toLowerCase(), nick: nickTrim }));
  localStorage.setItem("nickname", nickTrim); // redundancia por si acaso
}

function getUser() {
  // Prioridad 1: datos locales
  const raw = localStorage.getItem(USER_KEY);
  if (raw) {
    try { return JSON.parse(raw); } catch {}
  }

  // Prioridad 2: nickname directo
  const nick = localStorage.getItem("nickname");
  if (nick) return { id: 'local:' + nick.toLowerCase(), nick };

  // Prioridad 3: usuario Supabase (solo correo)
  const session = window._lastSupabaseSession; // guardaremos aqu√≠ la sesi√≥n m√°s reciente
  const email = session?.user?.email;
  if (email) return { id: 'supabase:' + email.toLowerCase(), nick: email };

  return null;
}
// üß† Asegurar que el nickname se guarde si el usuario est√° autenticado en Supabase
(async () => {
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;
  if (user) {
    window._lastSupabaseSession = data.session;
    let nickname = localStorage.getItem("nickname");
    if (!nickname) {
      nickname = prompt("Ingresa tu nickname (solo la primera vez):");
      if (nickname) {
        localStorage.setItem("nickname", nickname.trim());
        setUser(nickname.trim());
      }
    }
  }
})();


function delUser() {
  localStorage.removeItem(USER_KEY);
  localStorage.removeItem("nickname");
}


    let DB = loadDB();

    /********************
     * UI & NAVEGACI√ìN  *
     ********************/
    const $ = (sel) => document.querySelector(sel);
    const views = {
      play: $('#viewPlay'),
      create: $('#viewCreate'),
      feed: $('#viewFeed'),
      login: $('#viewLogin'),
    };

function show(which) {
  // Ocultar todas las vistas
  Object.values(views).forEach(v => v.classList.add('hidden'));
  views[which].classList.remove('hidden');

  // Si est√°s en "play", carga una pregunta aleatoria
  if (which === 'play') {
    loadRandom();
  }

  // Si est√°s en "feed", carga las preguntas y tags populares
  if (which === 'feed') {
    renderFeed();
    loadPopularTags();
  }

  // Si est√°s en "create", carga las sugerencias de tags
  if (which === 'create') {
    loadTagSuggestions();
  }

  // Actualizar la barra de navegaci√≥n
  updateNav();
}

    

    $('#navPlay').onclick = () => show('play');
    $('#navCreate').onclick = () => show('create');
    $('#navFeed').onclick = () => show('feed');
 
    

    // LOGIN
    $('#setNick').onclick = () => {
      const nick = $('#nick').value.trim();
      if (!nick) return alert('Escribe un nickname');
      setUser(nick); updateNav(); alert('‚úì Usuario guardado');
    };
    $('#logout').onclick = () => { delUser(); updateNav(); alert('Sesi√≥n local eliminada'); };

        // === FOTO DE PERFIL LOCAL ===
    document.getElementById("profilePic").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        localStorage.setItem("user_photo", dataUrl);
        document.getElementById("profilePreview").src = dataUrl;
      };
      reader.readAsDataURL(file);
    });


    // Al cargar la vista de login, mostrar la imagen si ya hay una guardada
    window.addEventListener("load", () => {
      const savedPhoto = localStorage.getItem("user_photo");
      if (savedPhoto) document.getElementById("profilePreview").src = savedPhoto;
    });

    // HELPERS
    function readFileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function resolveImage(urlInput, fileInput){
      const url = urlInput.value.trim();
      if (url) return url; // usar URL directa
      const file = fileInput.files?.[0];
      if (file) {
        // Nota: se guarda como base64 en localStorage (solo prototipo)
        try { return await readFileToDataUrl(file); } catch { return null; }
      }
      return null;
    }

    // CREATE
    const fileA = $('#fileA');
    const fileB = $('#fileB');
    const urlA  = $('#urlA');
    const urlB  = $('#urlB');
    const prevA = $('#prevA');
    const prevB = $('#prevB');

    fileA?.addEventListener('change', async () => { const f = fileA.files?.[0]; prevA.src = f ? await readFileToDataUrl(f) : ''; });
    fileB?.addEventListener('change', async () => { const f = fileB.files?.[0]; prevB.src = f ? await readFileToDataUrl(f) : ''; });
    urlA?.addEventListener('change', () => { prevA.src = urlA.value || ''; });
    urlB?.addEventListener('change', () => { prevB.src = urlB.value || ''; });

    // Imagen principal de la pregunta
    const fileQ = $('#fileQ');
    const urlQ = $('#urlQ');
    const prevQ = $('#prevQ');

    fileQ?.addEventListener('change', async () => {
      const f = fileQ.files?.[0];
      prevQ.src = f ? await readFileToDataUrl(f) : '';
    });
    urlQ?.addEventListener('change', () => {
      prevQ.src = urlQ.value || '';
    });





// ‚úÖ Guardar pregunta con autor y foto del perfil
$('#saveQ').onclick = async () => {
  try {
    const u = getUser();
    if (!u) return alert('Primero inicia sesi√≥n (nickname o cuenta).');

    const q = $('#inpQ').value.trim();
    const a = $('#inpA').value.trim();
    const b = $('#inpB').value.trim();
    const tags = $('#inpTags')?.value?.trim() || '';

    // Leer im√°genes (principal, A y B)
    const qImg = await resolveImage(urlQ, fileQ);
    const aImg = await resolveImage(urlA, fileA);
    const bImg = await resolveImage(urlB, fileB);

    if (!q || !a || !b)
      return alert('Completa la pregunta y ambas opciones.');

    console.log("üß† Datos antes de insertar:", { q, a, b, tags, qImg });

    // Intentar obtener datos del usuario actual
    const { data: userData, error: userError } = await sb.auth.getUser();
    if (userError) console.warn("Error obteniendo user:", userError);

    const user = userData?.user;
    let perfil = null;
    let fotoFinal = null;

    if (user) {
      const { data: p, error: perError } = await sb
        .from("perfiles")
        .select("username, foto")
        .eq("id", user.id)
        .maybeSingle();

      if (perError) console.warn("Error buscando perfil:", perError);
      perfil = p;
    }

    const fotoLocal = localStorage.getItem("user_photo");
    fotoFinal = perfil?.foto || fotoLocal || null;

    // üî• Insertar en la tabla preguntas
    const { data, error } = await sb.from("preguntas").insert({
      pregunta: q,
      opcion_a: a,
      opcion_b: b,
      imagen_a: aImg || null,
      imagen_b: bImg || null,
      imagen_pregunta: qImg || null, // üí• nueva imagen principal
      autor: perfil?.username || u.nick || "An√≥nimo",
      foto_autor: fotoFinal || null,
      tags: tags.toString(),
      votos_a: 0,
      votos_b: 0,
      created_at: new Date().toISOString()
    }).select();

    if (error) {
      console.error("‚ùå Error al insertar:", error);
      alert('‚ö†Ô∏è Error al publicar la pregunta. Revisa la consola.');
    } else {
      console.log("‚úÖ Insert correcto:", data);
      alert('‚úÖ Pregunta publicada correctamente.');

      // limpiar formulario
      $('#inpQ').value = '';
      $('#inpA').value = '';
      $('#inpB').value = '';
      $('#inpTags').value = '';
      urlA.value = '';
      urlB.value = '';
      urlQ.value = '';
      if (prevA) prevA.src = '';
      if (prevB) prevB.src = '';
      if (prevQ) prevQ.src = '';
      if (fileA) fileA.value = '';
      if (fileB) fileB.value = '';
      if (fileQ) fileQ.value = '';

      show('play');
    }
  } catch (err) {
    console.error("üí• Error inesperado en saveQ:", err);
    alert('‚ö†Ô∏è Ocurri√≥ un error inesperado. Revisa la consola.');
  }
};


    // PLAY
    let current = null;
    function setOption(elMedia, elCaption, text, img){
      elCaption.textContent = text || '';
      elMedia.innerHTML = '';
      if (img) {
        const im = new Image();
        im.loading = 'lazy';
        im.decoding = 'async';
        im.alt = text || '';
        im.src = img;
        elMedia.appendChild(im);
      } else {
        elMedia.innerHTML = '<span class="muted">Sin imagen</span>';
      }
    }

async function loadRandom() {
  try {
    const { data, error } = await sb
      .from('preguntas')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) throw error;

    if (!data || data.length === 0) {
      $('#qText').textContent = "No hay preguntas a√∫n üò¢";
      $('#qAuthor').textContent = "";
      return;
    }

    // Elegir una pregunta aleatoria
    const item = data[Math.floor(Math.random() * data.length)];
    current = item;
    const authorBox = document.getElementById('qAuthor');
    authorBox.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
        <img src="${item.foto_autor || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" 
            style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
        <span>${item.autor || 'An√≥nimo'}</span>
      </div>
    `;

    $('#qText').textContent = item.pregunta;
    setOption($('#mediaA'), $('#captionA'), item.opcion_a, item.imagen_a);
    setOption($('#mediaB'), $('#captionB'), item.opcion_b, item.imagen_b);
    $('#result').classList.add('hidden');
  } catch (err) {
    console.error("Error cargando pregunta:", err);
    $('#qText').textContent = "‚ö†Ô∏è Error cargando preguntas";
  }
}


async function vote(which) {
  const u = getUser();
  if (!u) return alert('Primero inicia sesi√≥n (nickname).');
  if (!current) return;

  const field = which === 'A' ? 'votos_a' : 'votos_b';
  const newValue = (current[field] || 0) + 1;

  const { error } = await sb
    .from('preguntas')
    .update({ [field]: newValue })
    .eq('id', current.id);

  if (error) {
    console.error(error);
    alert('‚ö†Ô∏è Error registrando el voto.');
    return;
  }

  current[field] = newValue;
  showResult();
}


function showResult() {
  // Usamos los nombres reales de columnas de tu tabla
  const votosA = Number(current.votos_a ?? 0);
  const votosB = Number(current.votos_b ?? 0);
  const total = votosA + votosB;

  // Si a√∫n no hay votos, mostramos 0%
  const pctA = total > 0 ? Math.round((votosA / total) * 100) : 0;
  const pctB = total > 0 ? Math.round((votosB / total) * 100) : 0;

  // Actualizamos los textos y barras
  $('#pctA').textContent = `${pctA}%`;
  $('#pctB').textContent = `${pctB}%`;
  $('#fillA').style.width = `${pctA}%`;
  $('#fillB').style.width = `${pctB}%`;

  $('#result').classList.remove('hidden');
}


    $('#optA').onclick = () => vote('A');
    $('#optB').onclick = () => vote('B');
    $('#next').onclick = () => loadRandom();

    $('#share').onclick = async () => {
      const text = `¬øQu√© prefieres? ${current.q}
A) ${current.a}
B) ${current.b}`;
      try {
        await navigator.clipboard.writeText(text);
        alert('Copiado al portapapeles ‚úÖ');
      } catch {
        alert('No se pudo copiar.');
      }
    };


/*******************************
 * üß† Cargar sugerencias de tags
 *******************************/
async function loadTagSuggestions() {
  try {
    const { data, error } = await sb
      .from("preguntas")
      .select("tags");

    if (error) throw error;

    const tagsUnicos = new Set();

    data.forEach(row => {
      if (row.tags) {
        const t = Array.isArray(row.tags) ? row.tags : row.tags.split(",");
        t.forEach(x => {
          const clean = x.trim().toLowerCase();
          if (clean) tagsUnicos.add(clean);
        });
      }
    });

    // Rellenar datalist
    const list = document.getElementById("tagsSugeridos");
    list.innerHTML = ""; // limpiar viejo

    Array.from(tagsUnicos).forEach(tag => {
      const opt = document.createElement("option");
      opt.value = tag;
      list.appendChild(opt);
    });

    console.log(`‚úÖ ${tagsUnicos.size} tags cargados en sugerencias.`);
  } catch (err) {
    console.error("‚ö†Ô∏è Error cargando tags sugeridos:", err);
  }
}


    // FEED
async function renderFeed() {
  try {
    const list = document.getElementById("feedList");
    list.innerHTML = "<p class='muted'>Cargando preguntas...</p>";

    const { data, error } = await sb
      .from("preguntas")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) throw error;

    if (!data || data.length === 0) {
      list.innerHTML = "<p class='muted'>No hay preguntas todav√≠a üò¢</p>";
      return;
    }

    list.innerHTML = "";

    data.forEach(item => {
      const total = (item.votos_a + item.votos_b) || 0;
      const pct = total ? Math.round(item.votos_a * 100 / total) : 0;

      const el = document.createElement("div");
      el.className = "card stack";
      el.style.padding = "18px";

      el.innerHTML = `
        <!-- üßë Autor con foto -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <img src="${item.foto_autor || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
               alt="foto de autor"
               style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid #303a5a;">
          <span class="muted" style="font-size:14px;">Por <strong>${item.autor || 'An√≥nimo'}</strong></span>
        </div>

        <!-- ‚ùì Pregunta -->
        <div class="question-text center">${item.pregunta}</div>

        <!-- üñºÔ∏è Opciones -->
        <div class="row two" style="margin-top:8px;">
          <div class="thumb">${item.imagen_a ? `<img src="${item.imagen_a}" alt="A"/>` : '<span class="muted">Sin imagen</span>'}</div>
          <div class="thumb">${item.imagen_b ? `<img src="${item.imagen_b}" alt="B"/>` : '<span class="muted">Sin imagen</span>'}</div>
        </div>

        <!-- üÖ∞Ô∏è y üÖ±Ô∏è textos -->
        <div class="row two">
          <div class="pill">A: ${item.opcion_a}</div>
          <div class="pill right">B: ${item.opcion_b}</div>
        </div>

        <!-- üìä Votos -->
        <div class="stats">
          <div class="bar"><div class="fill a" style="width:${pct}%"></div></div>
          <div class="bar"><div class="fill b" style="width:${100 - pct}%"></div></div>
        </div>

        <!-- üéÆ Bot√≥n de jugar -->
        <div class="row two" style="margin-top:10px;">
          <button class="btn" data-id="${item.id}">Jugar esta</button>
          <div class="pill">Votos: ${total}</div>
        </div>
      `;

      el.querySelector("button").onclick = () => {
        current = item;
        document.getElementById("qAuthor").innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
            <img src="${item.foto_autor || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                 style="width:28px;height:28px;border-radius:50%;object-fit:cover;">
            <span>${item.autor || 'An√≥nimo'}</span>
          </div>`;
        document.getElementById("qText").textContent = item.pregunta;
        setOption(document.getElementById("mediaA"), document.getElementById("captionA"), item.opcion_a, item.imagen_a);
        setOption(document.getElementById("mediaB"), document.getElementById("captionB"), item.opcion_b, item.imagen_b);
        show("play");
      };

      list.appendChild(el);
    });
  } catch (err) {
    console.error("Error cargando preguntas:", err);
    document.getElementById("feedList").innerHTML = "<p class='muted'>‚ö†Ô∏è Error cargando preguntas.</p>";
  }
}


  /***********************
 * üî• TAGS POPULARES
 ***********************/
async function loadPopularTags() {
  try {
    const { data, error } = await sb.rpc('get_popular_tags');
    const tagsList = document.getElementById('tagsList');
    if (error) throw error;

    if (!data || data.length === 0) {
      tagsList.textContent = "No hay tags a√∫n üò¢";
      return;
    }

    // Mostrar tags como botones clickeables
    tagsList.innerHTML = data
      .map(t => `<button class="btn tag-btn" data-tag="${t.tag}">${t.tag} (${t.count})</button>`)
      .join(' ');

    // Asignar acci√≥n a cada bot√≥n
    document.querySelectorAll('.tag-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        searchByTag(btn.dataset.tag);
      });
    });
  } catch (err) {
    console.error("Error cargando tags:", err);
    document.getElementById('tagsList').textContent = "‚ö†Ô∏è Error cargando tags.";
  }
}

/***********************
 * üîé BUSCAR POR TAG
 ***********************/
async function searchByTag(tagName) {
  try {
    const list = document.getElementById('feedList');
    list.innerHTML = `<p class="muted">Buscando preguntas con el tag <strong>${tagName}</strong>...</p>`;

    const { data, error } = await sb
      .from('preguntas')
      .select('*')
      .contains('tags', [tagName]); // busca coincidencias en el array

    if (error) throw error;

    if (!data || data.length === 0) {
      list.innerHTML = `<p class="muted">No se encontraron preguntas con el tag <strong>${tagName}</strong>.</p>`;
      return;
    }

    // Mostrar resultados reutilizando el render
    list.innerHTML = "";
    data.forEach(item => {
      const total = (item.votos_a + item.votos_b) || 0;
      const pct = total ? Math.round(item.votos_a * 100 / total) : 0;

      const el = document.createElement('div');
      el.className = 'card stack';
      el.innerHTML = `
        <div class="muted">Por <strong>${item.autor || 'An√≥nimo'}</strong></div>
        <div class="question-text center">${item.pregunta}</div>
        <div class="row two">
          <div class="thumb">${item.imagen_a ? `<img src="${item.imagen_a}" alt="A"/>` : '<span class="muted">Sin imagen</span>'}</div>
          <div class="thumb">${item.imagen_b ? `<img src="${item.imagen_b}" alt="B"/>` : '<span class="muted">Sin imagen</span>'}</div>
        </div>
        <div class="row two">
          <div class="pill">A: ${item.opcion_a}</div>
          <div class="pill right">B: ${item.opcion_b}</div>
        </div>
      `;
      list.appendChild(el);
    });
  } catch (err) {
    console.error("Error en b√∫squeda:", err);
  }
}

// Asignar acci√≥n al bot√≥n Buscar
document.getElementById('btnSearchTag').addEventListener('click', () => {
  const tag = document.getElementById('searchTag').value.trim();
  if (tag) searchByTag(tag);
});

// üåü Cargar y mostrar los tags m√°s populares
async function loadPopularTags() {
  const cont = document.getElementById('popularTags');
  const loading = document.getElementById('tagsLoading');

  try {
    // Consulta SQL directa para contar las etiquetas m√°s usadas
    const { data, error } = await sb.rpc('get_popular_tags');
    if (error) throw error;

    if (!data || data.length === 0) {
      loading.textContent = "No hay etiquetas todav√≠a üò¢";
      return;
    }

    loading.remove();
    cont.innerHTML = '';

    data.forEach(tag => {
      const el = document.createElement('span');
      el.className = 'pill';
      el.style.cursor = 'pointer';
      el.textContent = `#${tag.tag} (${tag.count})`;
      el.onclick = () => filterByTag(tag.tag);
      cont.appendChild(el);
    });
  } catch (err) {
    console.error("Error cargando tags populares:", err);
    loading.textContent = "‚ö†Ô∏è No se pudieron cargar las etiquetas.";
  }
}

async function filterByTag(tag) {
  try {
    const list = $('#feedList');
    list.innerHTML = `<p class='muted'>Buscando preguntas con el tag <b>#${tag}</b>...</p>`;

    const { data, error } = await sb
      .from('preguntas')
      .select('*')
      .contains('tags', [tag]); // filtra preguntas que contengan el tag

    if (error) throw error;

    if (!data || data.length === 0) {
      list.innerHTML = `<p class='muted'>No hay preguntas con el tag <b>#${tag}</b> üò¢</p>`;
      return;
    }

    list.innerHTML = '';
    data.forEach(item => {
      const total = (item.votos_a + item.votos_b) || 0;
      const pct = total ? Math.round(item.votos_a * 100 / total) : 0;

      const el = document.createElement('div');
      el.className = 'card stack';
      el.innerHTML = `
        <div class="muted">Por <strong>${item.autor || 'An√≥nimo'}</strong></div>
        <div class="question-text center">${item.pregunta}</div>
        <div class="row two">
          <div class="thumb">${item.imagen_a ? `<img src="${item.imagen_a}" alt="A"/>` : '<span class="muted">Sin imagen</span>'}</div>
          <div class="thumb">${item.imagen_b ? `<img src="${item.imagen_b}" alt="B"/>` : '<span class="muted">Sin imagen</span>'}</div>
        </div>
        <div class="row two">
          <div class="pill">A: ${item.opcion_a}</div>
          <div class="pill right">B: ${item.opcion_b}</div>
        </div>
        <div class="stats">
          <div class="bar"><div class="fill a" style="width:${pct}%"></div></div>
          <div class="bar"><div class="fill b" style="width:${100 - pct}%"></div></div>
        </div>
      `;
      list.appendChild(el);
    });
  } catch (err) {
    console.error("Error filtrando por tag:", err);
  }
}
// ‚úÖ Funci√≥n que actualiza la barra de navegaci√≥n
function updateNav() {
  const navButtons = document.querySelectorAll('nav button');

  // Quitar color activo de todos
  navButtons.forEach(btn => btn.classList.remove('primary'));

  // Detectar qu√© vista est√° visible
  for (const [key, view] of Object.entries(views)) {
    if (!view.classList.contains('hidden')) {
      const navId = `nav${key.charAt(0).toUpperCase() + key.slice(1)}`;
      const btn = document.getElementById(navId);
      if (btn) btn.classList.add('primary'); // resalta el bot√≥n activo
    }
  }
}


    // START
    (function init(){
      updateNav();
      show('play');
    })();

    // === LOGIN SYSTEM ===

// Referencias a los botones
const btnSignIn = document.getElementById('btnSignIn');
const btnSignOut = document.getElementById('btnSignOut');
const authUser = document.getElementById('authUser');



// --- FUNCI√ìN DE LOGIN ---
btnSignIn.addEventListener('click', async () => {
  const email = prompt("üìß Ingresa tu correo para iniciar sesi√≥n:");

  if (!email) return alert("Debes ingresar un correo.");

  const { error } = await sb.auth.signInWithOtp({
    email: email,
    options: {
    emailRedirectTo: "https://luiskq1225-dotcom.github.io/survigames/"

  // vuelve a tu sitio
    }
  });

  if (error) {
    alert("Error al enviar el enlace: " + error.message);
  } else {
    alert("üì© Te enviamos un enlace m√°gico a tu correo. Revisa tu bandeja!");
  }
});


// --- ACTUALIZAR UI ---
// üîê Detectar inicio/cierre de sesi√≥n y redirigir si falta foto o nickname
sb.auth.onAuthStateChange(async (_event, session) => {
  const user = session?.user;
  if (user) {
    authUser.textContent = user.email;
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');

    await syncUserNickname(); // sincroniza nickname local

    // üß† Buscar si ya tiene perfil en Supabase
    const { data: perfil } = await sb
      .from("perfiles")
      .select("foto, username")
      .eq("id", user.id)
      .maybeSingle();

    const localFoto = localStorage.getItem("user_photo");
    const localNick = localStorage.getItem("nickname");

    // üö® Si no tiene nickname o foto ‚Üí llevarlo a la vista de perfil
    if ((!perfil?.foto && !localFoto) || !localNick) {
      alert("üì∏ Antes de continuar, personaliza tu perfil con una foto y nombre.");
      show('login');
    } else {
      show('play');
    }
  } else {
    authUser.textContent = 'Invitado';
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
    show('play');
  }
});



// Revisar si ya est√° logueado al cargar la p√°gina
(async () => {
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user;

  if (user) {
    // Mostrar email
    authUser.textContent = user.email;
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');

    // üß© Nuevo: obtener o guardar el nickname
    let nickname = localStorage.getItem("nickname");

    // Si no hay nickname guardado, ped√≠ uno o us√° el que el usuario haya escrito en login
    if (!nickname) {
      nickname = prompt("Ingresa tu nickname (solo la primera vez):");
      if (nickname) {
        localStorage.setItem("nickname", nickname.trim());
      }
    }

  } else {
    // No hay sesi√≥n activa
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
  }
})();
// üß© Si el usuario viene de "Explorar" y hab√≠a guardado una pregunta
window.addEventListener('load', () => {
  const last = localStorage.getItem('lastPlayed');
  if (last) {
    try {
      const item = JSON.parse(last);
      current = item;
      $('#qAuthor').textContent = item.author || 'anon';
      $('#qText').textContent = item.q;
      setOption($('#mediaA'), $('#captionA'), item.a, item.aImg);
      setOption($('#mediaB'), $('#captionB'), item.b, item.bImg);
      $('#result').classList.add('hidden');
    } catch {}
    localStorage.removeItem('lastPlayed');
  }
});

// üîî Escuchar cambios en tiempo real
sb
  .channel('realtime-preguntas')
  .on(
    'postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'preguntas' },
    (payload) => {
      console.log('Nueva pregunta publicada:', payload.new);
      agregarPreguntaAExplorar(payload.new);
    }
  )
  .subscribe();

// üëá Esta funci√≥n agrega visualmente la nueva pregunta
function agregarPreguntaAExplorar(pregunta) {
  const contenedor = document.getElementById('explorarContainer');
  if (!contenedor) return;

  const item = document.createElement('div');
  item.classList.add('pregunta-card');
  item.innerHTML = `
    <h3>${pregunta.pregunta}</h3>
    <div class="opciones">
      <div><img src="${pregunta.imagen_a || ''}" alt="">${pregunta.opcion_a}</div>
      <div><img src="${pregunta.imagen_b || ''}" alt="">${pregunta.opcion_b}</div>
    </div>
    <p>Por: ${pregunta.autor || 'anon'}</p>
  `;
  contenedor.prepend(item);
}


 </script>
</body>
</html>


